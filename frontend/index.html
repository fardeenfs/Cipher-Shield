<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cipher Shield — Monitor</title>
  <style>
    /* ── Reset & Base ─────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0d0f14;
      --surface:  #151820;
      --border:   #252933;
      --muted:    #4a5168;
      --text:     #c8cdd8;
      --bright:   #e8ecf4;
      --accent:   #4f8ef7;
      --none:     #4a5168;
      --low:      #2ea874;
      --medium:   #d4993a;
      --high:     #d45a5a;
      --font: 'Segoe UI', system-ui, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      display: grid;
      grid-template-rows: 52px 1fr;
      grid-template-columns: 320px 1fr;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Header ───────────────────────────────────────────────────── */
    header {
      grid-column: 1 / -1;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
    }

    header .logo { font-size: 18px; font-weight: 700; color: var(--bright); letter-spacing: .5px; }
    header .logo span { color: var(--accent); }

    header .ws-badge {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    header .ws-badge .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--muted);
      transition: background .3s;
    }

    header .ws-badge.connected .dot   { background: var(--low); }
    header .ws-badge.connected .label { color: var(--low); }
    header .ws-badge.error .dot       { background: var(--high); }
    header .ws-badge.error .label     { color: var(--high); }

    /* ── Sidebar ──────────────────────────────────────────────────── */
    aside {
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .8px;
      text-transform: uppercase;
      color: var(--muted);
      padding: 14px 16px 8px;
    }

    /* ── Add Stream Form ──────────────────────────────────────────── */
    .add-form {
      padding: 0 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border-bottom: 1px solid var(--border);
    }

    .add-form input, .add-form select {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--bright);
      font-family: var(--font);
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
      transition: border-color .2s;
      width: 100%;
    }

    .add-form input:focus, .add-form select:focus { border-color: var(--accent); }
    .add-form input::placeholder { color: var(--muted); }

    .row { display: flex; gap: 6px; }
    .row input { flex: 1; }

    .btn {
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 13px;
      font-weight: 600;
      padding: 7px 14px;
      transition: opacity .15s;
    }
    .btn:hover { opacity: .85; }
    .btn:active { opacity: .7; }

    .btn-primary { background: var(--accent); color: #fff; width: 100%; }
    .btn-sm      { font-size: 11px; padding: 3px 8px; }
    .btn-danger  { background: #3a1e1e; color: var(--high); border: 1px solid #5a2a2a; }
    .btn-toggle  { background: #1a2a1a; color: var(--low);  border: 1px solid #2a4a2a; }
    .btn-toggle.off { background: #2a2a1a; color: var(--medium); border-color: #4a3a1a; }

    /* ── Stream List ──────────────────────────────────────────────── */
    .stream-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .stream-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
    }

    .stream-card .sc-top {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .stream-card .sc-name {
      font-weight: 600;
      color: var(--bright);
      font-size: 13px;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stream-card .sc-meta {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stream-card .sc-type {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .5px;
      text-transform: uppercase;
      background: var(--border);
      color: var(--muted);
      border-radius: 4px;
      padding: 2px 6px;
    }

    .stream-card .sc-actions { display: flex; gap: 4px; }

    .empty-state {
      color: var(--muted);
      font-size: 12px;
      text-align: center;
      padding: 20px 0;
    }

    /* ── Main area ────────────────────────────────────────────────── */
    main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Tabs ─────────────────────────────────────────────────────── */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      padding: 0 16px;
    }

    .tab {
      padding: 14px 16px;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color .15s, border-color .15s;
      user-select: none;
    }

    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .tab-count {
      display: inline-block;
      background: var(--border);
      color: var(--muted);
      font-size: 10px;
      font-weight: 700;
      border-radius: 10px;
      padding: 1px 6px;
      margin-left: 5px;
    }

    .tab.active .tab-count { background: #1a2a4a; color: var(--accent); }

    /* ── Tab panels ───────────────────────────────────────────────── */
    .tab-panel { display: none; flex: 1; overflow: hidden; }
    .tab-panel.active { display: flex; flex-direction: column; }

    /* ── Live Feed ────────────────────────────────────────────────── */
    .feed-toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
    }

    .feed-toolbar label { font-size: 12px; color: var(--muted); }

    .filter-pills { display: flex; gap: 4px; }

    .pill {
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: all .15s;
      color: var(--muted);
      background: transparent;
    }
    .pill:hover { color: var(--text); }
    .pill.active-none   { border-color: var(--none);   color: var(--none);   background: #1a1e2a; }
    .pill.active-low    { border-color: var(--low);    color: var(--low);    background: #0f2a1e; }
    .pill.active-medium { border-color: var(--medium); color: var(--medium); background: #2a1e0a; }
    .pill.active-high   { border-color: var(--high);   color: var(--high);   background: #2a0f0f; }

    .clear-btn {
      margin-left: auto;
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      font-size: 12px;
      padding: 3px 10px;
      cursor: pointer;
    }
    .clear-btn:hover { color: var(--text); border-color: var(--text); }

    .event-feed {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* ── Event Card ───────────────────────────────────────────────── */
    .event-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--none);
      border-radius: 8px;
      padding: 10px 14px;
      animation: slideIn .2s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .event-card[data-risk="low"]    { border-left-color: var(--low); }
    .event-card[data-risk="medium"] { border-left-color: var(--medium); }
    .event-card[data-risk="high"]   { border-left-color: var(--high); }

    .event-card .ec-top {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
    }

    .risk-badge {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .5px;
      text-transform: uppercase;
      border-radius: 4px;
      padding: 2px 7px;
    }
    .risk-none   { background: #1e2030; color: var(--none); }
    .risk-low    { background: #0f2a1e; color: var(--low); }
    .risk-medium { background: #2a1e0a; color: var(--medium); }
    .risk-high   { background: #2a0f0f; color: var(--high); }

    .ec-stream { font-size: 11px; color: var(--accent); font-weight: 600; }
    .ec-time   { font-size: 11px; color: var(--muted); margin-left: auto; }

    .ec-description { font-size: 13px; color: var(--text); margin-bottom: 6px; line-height: 1.5; }

    .ec-tags { display: flex; flex-wrap: wrap; gap: 4px; }

    .event-tag {
      font-size: 10px;
      background: var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 2px 7px;
    }

    /* ── History Tab ──────────────────────────────────────────────── */
    .history-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .history-toolbar select, .history-toolbar input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: var(--font);
      font-size: 12px;
      padding: 5px 8px;
      outline: none;
    }
    .history-toolbar select:focus, .history-toolbar input:focus { border-color: var(--accent); }

    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* ── Scrollbar ────────────────────────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

    /* ── Toast ────────────────────────────────────────────────────── */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 13px;
      color: var(--bright);
      opacity: 0;
      transform: translateY(10px);
      transition: all .25s;
      pointer-events: none;
      z-index: 999;
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.ok  { border-left: 3px solid var(--low); }
    #toast.err { border-left: 3px solid var(--high); }
  </style>
</head>
<body>

<!-- ── Header ──────────────────────────────────────────────────────────── -->
<header>
  <div class="logo">Cipher<span>Shield</span></div>
  <div class="ws-badge" id="wsBadge">
    <div class="dot"></div>
    <span class="label">Disconnected</span>
  </div>
</header>

<!-- ── Sidebar ─────────────────────────────────────────────────────────── -->
<aside>
  <div class="panel-title">Add Stream</div>

  <div class="add-form">
    <input id="sName"     type="text"   placeholder="Name (e.g. Front Door)" />
    <select id="sType">
      <option value="snapshot">HTTP Snapshot</option>
      <option value="rtsp">RTSP</option>
      <option value="mjpeg">HTTP MJPEG</option>
      <option value="usb">USB / Webcam</option>
    </select>
    <input id="sUrl"      type="text"   placeholder="URL or device ID" />
    <div class="row">
      <input id="sInterval" type="number" placeholder="Interval (sec)" value="5" min="1" style="max-width:130px" />
    </div>
    <button class="btn btn-primary" onclick="addStream()">+ Add Stream</button>
  </div>

  <div class="panel-title" style="margin-top:4px">Streams</div>
  <div class="stream-list" id="streamList">
    <div class="empty-state">No streams yet</div>
  </div>
</aside>

<!-- ── Main ────────────────────────────────────────────────────────────── -->
<main>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('live', this)">
      Live Feed <span class="tab-count" id="liveCount">0</span>
    </div>
    <div class="tab" onclick="switchTab('history', this)">
      History
    </div>
  </div>

  <!-- Live tab -->
  <div class="tab-panel active" id="tab-live">
    <div class="feed-toolbar">
      <span style="font-size:12px;color:var(--muted)">Filter:</span>
      <div class="filter-pills">
        <div class="pill" data-risk="none"   onclick="togglePill(this)">None</div>
        <div class="pill" data-risk="low"    onclick="togglePill(this)">Low</div>
        <div class="pill" data-risk="medium" onclick="togglePill(this)">Medium</div>
        <div class="pill" data-risk="high"   onclick="togglePill(this)">High</div>
      </div>
      <button class="clear-btn" onclick="clearFeed()">Clear</button>
    </div>
    <div class="event-feed" id="eventFeed">
      <div class="empty-state" id="feedEmpty" style="margin-top:40px">
        Waiting for events…
      </div>
    </div>
  </div>

  <!-- History tab -->
  <div class="tab-panel" id="tab-history">
    <div class="history-toolbar">
      <select id="hStream" onchange="loadHistory()">
        <option value="">All streams</option>
      </select>
      <select id="hRisk" onchange="loadHistory()">
        <option value="">All risk levels</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
        <option value="none">None</option>
      </select>
      <input id="hFrom" type="datetime-local" onchange="loadHistory()" />
      <input id="hTo"   type="datetime-local" onchange="loadHistory()" />
      <button class="btn btn-primary btn-sm" onclick="loadHistory()">Refresh</button>
    </div>
    <div class="history-list" id="historyList">
      <div class="empty-state">Select filters and click Refresh</div>
    </div>
  </div>
</main>

<div id="toast"></div>

<script>
  const API = 'http://localhost:8080';
  const WS  = 'ws://localhost:8080/ws/events';

  // ── State ────────────────────────────────────────────────────────────────
  let streams    = [];
  let liveEvents = [];
  let activeFilters = new Set();  // empty = show all

  // ── WebSocket ────────────────────────────────────────────────────────────
  let ws, wsReconnectTimer;

  function connectWs() {
    ws = new WebSocket(WS);

    ws.onopen = () => {
      setBadge('connected', 'Live');
    };

    ws.onmessage = (e) => {
      try {
        const event = JSON.parse(e.data);
        if (event.type === 'lag_warning') return;
        onLiveEvent(event);
      } catch {}
    };

    ws.onclose = () => {
      setBadge('', 'Disconnected');
      clearTimeout(wsReconnectTimer);
      wsReconnectTimer = setTimeout(connectWs, 3000);
    };

    ws.onerror = () => {
      setBadge('error', 'Error');
      ws.close();
    };
  }

  function setBadge(cls, label) {
    const b = document.getElementById('wsBadge');
    b.className = 'ws-badge ' + cls;
    b.querySelector('.label').textContent = label;
  }

  // ── Live Events ───────────────────────────────────────────────────────────
  function onLiveEvent(event) {
    liveEvents.unshift(event);
    if (liveEvents.length > 200) liveEvents.pop();

    document.getElementById('liveCount').textContent = liveEvents.length;
    document.getElementById('feedEmpty').style.display = 'none';

    const feed = document.getElementById('eventFeed');
    const card = buildEventCard(event);

    if (activeFilters.size === 0 || activeFilters.has(event.risk_level)) {
      feed.insertBefore(card, feed.children[1]); // after empty placeholder
    }
  }

  function buildEventCard(event) {
    const streamName = (streams.find(s => s.id === event.stream_id) || {}).name || event.stream_id;
    const tags = (event.events || []).map(e =>
      `<span class="event-tag">${fmt(e.event_type)}${e.confidence ? ' · ' + Math.round(e.confidence * 100) + '%' : ''}</span>`
    ).join('');

    const card = document.createElement('div');
    card.className = 'event-card';
    card.dataset.risk = event.risk_level || 'none';
    card.dataset.id   = event.id;
    card.innerHTML = `
      <div class="ec-top">
        <span class="risk-badge risk-${event.risk_level || 'none'}">${event.risk_level || 'none'}</span>
        <span class="ec-stream">${streamName}</span>
        <span class="ec-time">${fmtTime(event.captured_at)}</span>
      </div>
      <div class="ec-description">${event.description || '—'}</div>
      ${tags ? `<div class="ec-tags">${tags}</div>` : ''}
    `;
    return card;
  }

  function togglePill(el) {
    const risk = el.dataset.risk;
    if (activeFilters.has(risk)) {
      activeFilters.delete(risk);
      el.className = 'pill';
    } else {
      activeFilters.add(risk);
      el.className = `pill active-${risk}`;
    }
    renderFeed();
  }

  function renderFeed() {
    const feed = document.getElementById('eventFeed');
    // Keep only the empty placeholder
    while (feed.children.length > 1) feed.removeChild(feed.lastChild);

    const visible = activeFilters.size === 0
      ? liveEvents
      : liveEvents.filter(e => activeFilters.has(e.risk_level));

    if (visible.length === 0) {
      document.getElementById('feedEmpty').style.display = '';
    } else {
      document.getElementById('feedEmpty').style.display = 'none';
      visible.forEach(e => feed.appendChild(buildEventCard(e)));
    }
  }

  function clearFeed() {
    liveEvents = [];
    document.getElementById('liveCount').textContent = '0';
    document.getElementById('feedEmpty').style.display = '';
    const feed = document.getElementById('eventFeed');
    while (feed.children.length > 1) feed.removeChild(feed.lastChild);
  }

  // ── Streams ───────────────────────────────────────────────────────────────
  async function loadStreams() {
    try {
      const res = await fetch(`${API}/api/streams`);
      streams = await res.json();
      renderStreams();
      syncHistoryStreamFilter();
    } catch (e) {
      toast('Could not reach backend', 'err');
    }
  }

  function renderStreams() {
    const list = document.getElementById('streamList');
    if (!streams.length) {
      list.innerHTML = '<div class="empty-state">No streams yet</div>';
      return;
    }
    list.innerHTML = streams.map(s => `
      <div class="stream-card" id="sc-${s.id}">
        <div class="sc-top">
          <span class="sc-name" title="${s.name}">${s.name}</span>
          <span class="sc-type">${s.source_type}</span>
        </div>
        <div class="sc-meta" title="${s.source_url}">${s.source_url}</div>
        <div class="sc-meta">Every ${s.capture_interval_sec}s</div>
        <div class="sc-actions">
          <button class="btn btn-sm btn-toggle ${s.enabled ? '' : 'off'}"
                  onclick="toggleStream('${s.id}', ${s.enabled})">
            ${s.enabled ? 'Enabled' : 'Disabled'}
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteStream('${s.id}')">Delete</button>
        </div>
      </div>
    `).join('');
  }

  function syncHistoryStreamFilter() {
    const sel = document.getElementById('hStream');
    const current = sel.value;
    sel.innerHTML = '<option value="">All streams</option>' +
      streams.map(s => `<option value="${s.id}" ${s.id === current ? 'selected' : ''}>${s.name}</option>`).join('');
  }

  async function addStream() {
    const name     = document.getElementById('sName').value.trim();
    const type     = document.getElementById('sType').value;
    const url      = document.getElementById('sUrl').value.trim();
    const interval = parseInt(document.getElementById('sInterval').value) || 5;

    if (!name || !url) { toast('Name and URL are required', 'err'); return; }

    try {
      const res = await fetch(`${API}/api/streams`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, source_type: type, source_url: url, capture_interval_sec: interval }),
      });
      if (!res.ok) throw new Error(await res.text());
      document.getElementById('sName').value = '';
      document.getElementById('sUrl').value  = '';
      toast(`Stream "${name}" added`, 'ok');
      await loadStreams();
    } catch (e) {
      toast('Failed: ' + e.message, 'err');
    }
  }

  async function toggleStream(id, currentlyEnabled) {
    const action = currentlyEnabled ? 'disable' : 'enable';
    try {
      const res = await fetch(`${API}/api/streams/${id}/${action}`, { method: 'POST' });
      if (!res.ok) throw new Error(await res.text());
      toast(`Stream ${action}d`, 'ok');
      await loadStreams();
    } catch (e) {
      toast('Failed: ' + e.message, 'err');
    }
  }

  async function deleteStream(id) {
    if (!confirm('Delete this stream and all its events?')) return;
    try {
      const res = await fetch(`${API}/api/streams/${id}`, { method: 'DELETE' });
      if (!res.ok && res.status !== 204) throw new Error(await res.text());
      toast('Stream deleted', 'ok');
      await loadStreams();
    } catch (e) {
      toast('Failed: ' + e.message, 'err');
    }
  }

  // ── History ───────────────────────────────────────────────────────────────
  async function loadHistory() {
    const streamId = document.getElementById('hStream').value;
    const risk     = document.getElementById('hRisk').value;
    const from     = document.getElementById('hFrom').value;
    const to       = document.getElementById('hTo').value;

    const params = new URLSearchParams({ limit: 100 });
    if (streamId) params.set('stream_id', streamId);
    if (risk)     params.set('risk_level', risk);
    if (from)     params.set('from', new Date(from).toISOString());
    if (to)       params.set('to',   new Date(to).toISOString());

    try {
      const res = await fetch(`${API}/api/events?${params}`);
      const events = await res.json();
      renderHistory(events);
    } catch (e) {
      toast('Failed to load history', 'err');
    }
  }

  function renderHistory(events) {
    const list = document.getElementById('historyList');
    if (!events.length) {
      list.innerHTML = '<div class="empty-state">No events found</div>';
      return;
    }
    list.innerHTML = '';
    events.forEach(e => list.appendChild(buildEventCard(e)));
  }

  // ── Tabs ─────────────────────────────────────────────────────────────────
  function switchTab(name, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
    if (name === 'history') loadHistory();
  }

  // ── Helpers ───────────────────────────────────────────────────────────────
  function fmt(s) {
    return (s || '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  function fmtTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  let toastTimer;
  function toast(msg, type) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'show ' + (type || '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.className = '', 3000);
  }

  // ── Init ──────────────────────────────────────────────────────────────────
  loadStreams();
  connectWs();
</script>
</body>
</html>
