<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cipher Shield — Monitor</title>
  <style>
    /* ── Reset & Base ─────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0d0f14;
      --surface:  #151820;
      --border:   #252933;
      --muted:    #4a5168;
      --text:     #c8cdd8;
      --bright:   #e8ecf4;
      --accent:   #4f8ef7;
      --none:     #4a5168;
      --low:      #2ea874;
      --medium:   #d4993a;
      --high:     #d45a5a;
      --font: 'Segoe UI', system-ui, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      display: grid;
      grid-template-rows: 52px 1fr;
      grid-template-columns: 320px 1fr;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Header ───────────────────────────────────────────────────── */
    header {
      grid-column: 1 / -1;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
    }

    header .logo { font-size: 18px; font-weight: 700; color: var(--bright); letter-spacing: .5px; }
    header .logo span { color: var(--accent); }

    header .ws-badge {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    header .ws-badge .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--muted);
      transition: background .3s;
    }

    header .ws-badge.connected .dot   { background: var(--low); }
    header .ws-badge.connected .label { color: var(--low); }
    header .ws-badge.error .dot       { background: var(--high); }
    header .ws-badge.error .label     { color: var(--high); }

    /* ── Sidebar ──────────────────────────────────────────────────── */
    aside {
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .8px;
      text-transform: uppercase;
      color: var(--muted);
      padding: 14px 16px 8px;
    }

    /* ── Add Stream Form ──────────────────────────────────────────── */
    .add-form {
      padding: 0 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border-bottom: 1px solid var(--border);
    }

    .add-form input, .add-form select {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--bright);
      font-family: var(--font);
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
      transition: border-color .2s;
      width: 100%;
    }

    .add-form input:focus, .add-form select:focus { border-color: var(--accent); }
    .add-form input::placeholder { color: var(--muted); }

    .row { display: flex; gap: 6px; }
    .row input { flex: 1; }

    .btn {
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 13px;
      font-weight: 600;
      padding: 7px 14px;
      transition: opacity .15s;
    }
    .btn:hover { opacity: .85; }
    .btn:active { opacity: .7; }

    .btn-primary { background: var(--accent); color: #fff; width: 100%; }
    .btn-sm      { font-size: 11px; padding: 3px 8px; }
    .btn-danger  { background: #3a1e1e; color: var(--high); border: 1px solid #5a2a2a; }
    .btn-toggle  { background: #1a2a1a; color: var(--low);  border: 1px solid #2a4a2a; }
    .btn-toggle.off { background: #2a2a1a; color: var(--medium); border-color: #4a3a1a; }

    /* ── Stream List ──────────────────────────────────────────────── */
    .stream-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .stream-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
    }

    .stream-card .sc-top {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .stream-card .sc-name {
      font-weight: 600;
      color: var(--bright);
      font-size: 13px;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stream-card .sc-meta {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stream-card .sc-type {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .5px;
      text-transform: uppercase;
      background: var(--border);
      color: var(--muted);
      border-radius: 4px;
      padding: 2px 6px;
    }

    .stream-card .sc-actions { display: flex; gap: 4px; }

    .empty-state {
      color: var(--muted);
      font-size: 12px;
      text-align: center;
      padding: 20px 0;
    }

    /* ── Main area ────────────────────────────────────────────────── */
    main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Tabs ─────────────────────────────────────────────────────── */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      padding: 0 16px;
    }

    .tab {
      padding: 14px 16px;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color .15s, border-color .15s;
      user-select: none;
    }

    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .tab-count {
      display: inline-block;
      background: var(--border);
      color: var(--muted);
      font-size: 10px;
      font-weight: 700;
      border-radius: 10px;
      padding: 1px 6px;
      margin-left: 5px;
    }

    .tab.active .tab-count { background: #1a2a4a; color: var(--accent); }

    /* ── Tab panels ───────────────────────────────────────────────── */
    .tab-panel { display: none; flex: 1; overflow: hidden; }
    .tab-panel.active { display: flex; flex-direction: column; }

    /* ── Live Feed ────────────────────────────────────────────────── */
    .feed-toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
    }

    .feed-toolbar label { font-size: 12px; color: var(--muted); }

    .filter-pills { display: flex; gap: 4px; }

    .pill {
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: all .15s;
      color: var(--muted);
      background: transparent;
    }
    .pill:hover { color: var(--text); }
    .pill.active-none   { border-color: var(--none);   color: var(--none);   background: #1a1e2a; }
    .pill.active-low    { border-color: var(--low);    color: var(--low);    background: #0f2a1e; }
    .pill.active-medium { border-color: var(--medium); color: var(--medium); background: #2a1e0a; }
    .pill.active-high   { border-color: var(--high);   color: var(--high);   background: #2a0f0f; }

    .clear-btn {
      margin-left: auto;
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      font-size: 12px;
      padding: 3px 10px;
      cursor: pointer;
    }
    .clear-btn:hover { color: var(--text); border-color: var(--text); }

    .event-feed {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* ── Event Card ───────────────────────────────────────────────── */
    .event-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--none);
      border-radius: 8px;
      padding: 10px 14px;
      animation: slideIn .2s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .event-card[data-risk="low"]    { border-left-color: var(--low); }
    .event-card[data-risk="medium"] { border-left-color: var(--medium); }
    .event-card[data-risk="high"]   { border-left-color: var(--high); }

    .event-card .ec-top {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
    }

    .risk-badge {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .5px;
      text-transform: uppercase;
      border-radius: 4px;
      padding: 2px 7px;
    }
    .risk-none   { background: #1e2030; color: var(--none); }
    .risk-low    { background: #0f2a1e; color: var(--low); }
    .risk-medium { background: #2a1e0a; color: var(--medium); }
    .risk-high   { background: #2a0f0f; color: var(--high); }

    .ec-stream { font-size: 11px; color: var(--accent); font-weight: 600; }
    .ec-time   { font-size: 11px; color: var(--muted); margin-left: auto; }

    .ec-description { font-size: 13px; color: var(--text); margin-bottom: 6px; line-height: 1.5; }

    .ec-tags { display: flex; flex-wrap: wrap; gap: 4px; }

    .event-tag {
      font-size: 10px;
      background: var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 2px 7px;
    }

    .ec-triggered-rule {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
      font-size: 11px;
      color: var(--muted);
    }
    .ec-triggered-rule .tr-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .4px;
      background: #1e1a2e;
      color: #b0a0e0;
      border-radius: 3px;
      padding: 1px 5px;
      flex-shrink: 0;
    }
    .ec-triggered-rule .tr-desc {
      font-style: italic;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ── History Tab ──────────────────────────────────────────────── */
    .history-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .history-toolbar select, .history-toolbar input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: var(--font);
      font-size: 12px;
      padding: 5px 8px;
      outline: none;
    }
    .history-toolbar select:focus, .history-toolbar input:focus { border-color: var(--accent); }

    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* ── Cameras Grid ─────────────────────────────────────────────── */
    .cameras-grid {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
      align-content: start;
    }

    .camera-tile {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .camera-feed {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      object-fit: contain;
      display: block;
    }

    .camera-paused {
      width: 100%;
      aspect-ratio: 16/9;
      background: #0a0a0a;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 13px;
    }

    .camera-label {
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .live-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--low);
      box-shadow: 0 0 5px var(--low);
      animation: pulse 1.8s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: .3; }
    }

    /* ── Scrollbar ────────────────────────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

    /* ── Toast ────────────────────────────────────────────────────── */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 13px;
      color: var(--bright);
      opacity: 0;
      transform: translateY(10px);
      transition: all .25s;
      pointer-events: none;
      z-index: 999;
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.ok  { border-left: 3px solid var(--low); }
    #toast.err { border-left: 3px solid var(--high); }

    /* ── Stream Rules ─────────────────────────────────────────────── */
    .btn-rules { background: #1a1e3a; color: var(--accent); border: 1px solid #2a3050; }
    .btn-rules.open { background: #1a2a4a; border-color: var(--accent); }

    .rules-panel {
      margin-top: 8px;
      border-top: 1px solid var(--border);
      padding-top: 8px;
    }

    .rules-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }

    .rule-item {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 7px;
      background: var(--surface);
      border-radius: 5px;
      border: 1px solid var(--border);
    }

    .rule-badge {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .4px;
      padding: 1px 5px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .rule-none   { background: #1e2030; color: var(--none); }
    .rule-low    { background: #0f2a1e; color: var(--low); }
    .rule-medium { background: #2a1e0a; color: var(--medium); }
    .rule-high   { background: #2a0f0f; color: var(--high); }

    .rule-desc {
      flex: 1;
      font-size: 11px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .rule-btns { display: flex; gap: 3px; flex-shrink: 0; }

    .btn-icon {
      background: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--muted);
      cursor: pointer;
      font-size: 10px;
      line-height: 1;
      padding: 2px 5px;
      transition: all .15s;
    }
    .btn-icon:hover     { color: var(--text); border-color: var(--text); }
    .btn-icon.del:hover { color: var(--high); border-color: var(--high); }

    .rule-edit-row {
      display: flex;
      gap: 4px;
      align-items: center;
      width: 100%;
    }
    .rule-edit-row input, .rule-edit-row select {
      background: var(--bg);
      border: 1px solid var(--accent);
      border-radius: 4px;
      color: var(--bright);
      font-family: var(--font);
      font-size: 11px;
      padding: 3px 6px;
      outline: none;
    }
    .rule-edit-row input { flex: 1; min-width: 0; }
    .btn-save   { background: var(--low); border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 10px; font-weight: 600; padding: 3px 7px; }
    .btn-cancel { background: none; border: 1px solid var(--border); border-radius: 4px; color: var(--muted); cursor: pointer; font-size: 10px; padding: 3px 7px; }

    .rules-empty { font-size: 11px; color: var(--muted); text-align: center; padding: 4px 0 8px; }

    .add-rule-form {
      display: flex;
      gap: 4px;
      align-items: center;
      padding-top: 4px;
    }
    .add-rule-form input, .add-rule-form select {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--bright);
      font-family: var(--font);
      font-size: 11px;
      padding: 4px 7px;
      outline: none;
      transition: border-color .2s;
    }
    .add-rule-form input { flex: 1; min-width: 0; }
    .add-rule-form input:focus, .add-rule-form select:focus { border-color: var(--accent); }
    .add-rule-form input::placeholder { color: var(--muted); }
    .add-rule-form .sel-level { width: 72px; }
    .btn-add-rule {
      background: var(--accent);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 9px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .btn-add-rule:hover { opacity: .85; }
  </style>
</head>
<body>

<!-- ── Header ──────────────────────────────────────────────────────────── -->
<header>
  <div class="logo">Cipher<span>Shield</span></div>
  <div class="ws-badge" id="wsBadge">
    <div class="dot"></div>
    <span class="label">Disconnected</span>
  </div>
</header>

<!-- ── Sidebar ─────────────────────────────────────────────────────────── -->
<aside>
  <div class="panel-title">Add Stream</div>

  <div class="add-form">
    <input id="sName"     type="text"   placeholder="Name (e.g. Front Door)" />
    <select id="sType">
      <option value="snapshot">HTTP Snapshot</option>
      <option value="rtsp">RTSP</option>
      <option value="mjpeg">HTTP MJPEG</option>
      <option value="usb">USB / Webcam</option>
      <option value="mock">Mock (file / YouTube)</option>
    </select>
    <input id="sUrl"      type="text"   placeholder="URL or device ID" />
    <div class="row">
      <input id="sInterval" type="number" placeholder="Interval (sec)" value="5" min="1" style="max-width:130px" />
    </div>
    <button class="btn btn-primary" onclick="addStream()">+ Add Stream</button>
  </div>

  <div class="panel-title" style="margin-top:4px">Streams</div>
  <div class="stream-list" id="streamList">
    <div class="empty-state">No streams yet</div>
  </div>
</aside>

<!-- ── Main ────────────────────────────────────────────────────────────── -->
<main>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('cameras', this)">
      Cameras <span class="tab-count" id="camCount">0</span>
    </div>
    <div class="tab" onclick="switchTab('live', this)">
      Live Feed <span class="tab-count" id="liveCount">0</span>
    </div>
    <div class="tab" onclick="switchTab('history', this)">
      History
    </div>
  </div>

  <!-- Cameras tab -->
  <div class="tab-panel active" id="tab-cameras">
    <div class="cameras-grid" id="camerasGrid">
      <div class="empty-state" style="grid-column:1/-1;margin-top:40px">No streams configured</div>
    </div>
  </div>

  <!-- Live tab -->
  <div class="tab-panel" id="tab-live">
    <div class="feed-toolbar">
      <span style="font-size:12px;color:var(--muted)">Filter:</span>
      <div class="filter-pills">
        <div class="pill" data-risk="none"   onclick="togglePill(this)">None</div>
        <div class="pill" data-risk="low"    onclick="togglePill(this)">Low</div>
        <div class="pill" data-risk="medium" onclick="togglePill(this)">Medium</div>
        <div class="pill" data-risk="high"   onclick="togglePill(this)">High</div>
      </div>
      <button class="clear-btn" onclick="clearFeed()">Clear</button>
    </div>
    <div class="event-feed" id="eventFeed">
      <div class="empty-state" id="feedEmpty" style="margin-top:40px">
        Waiting for events…
      </div>
    </div>
  </div>

  <!-- History tab -->
  <div class="tab-panel" id="tab-history">
    <div class="history-toolbar">
      <select id="hStream" onchange="loadHistory()">
        <option value="">All streams</option>
      </select>
      <select id="hRisk" onchange="loadHistory()">
        <option value="">All risk levels</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
        <option value="none">None</option>
      </select>
      <input id="hFrom" type="datetime-local" onchange="loadHistory()" />
      <input id="hTo"   type="datetime-local" onchange="loadHistory()" />
      <button class="btn btn-primary btn-sm" onclick="loadHistory()">Refresh</button>
    </div>
    <div class="history-list" id="historyList">
      <div class="empty-state">Select filters and click Refresh</div>
    </div>
  </div>
</main>

<div id="toast"></div>

<script>
  const API = 'http://localhost:8080';
  const WS  = 'ws://localhost:8080/ws/events';

  // ── State ────────────────────────────────────────────────────────────────
  let streams       = [];
  let liveEvents    = [];
  let activeFilters = new Set();  // empty = show all
  let openRulePanels = new Set(); // stream ids whose rules panel is open

  // ── WebSocket ────────────────────────────────────────────────────────────
  let ws, wsReconnectTimer;

  function connectWs() {
    ws = new WebSocket(WS);

    ws.onopen = () => {
      setBadge('connected', 'Live');
    };

    ws.onmessage = (e) => {
      try {
        const event = JSON.parse(e.data);
        if (event.type === 'lag_warning') return;
        onLiveEvent(event);
      } catch {}
    };

    ws.onclose = () => {
      setBadge('', 'Disconnected');
      clearTimeout(wsReconnectTimer);
      wsReconnectTimer = setTimeout(connectWs, 3000);
    };

    ws.onerror = () => {
      setBadge('error', 'Error');
      ws.close();
    };
  }

  function setBadge(cls, label) {
    const b = document.getElementById('wsBadge');
    b.className = 'ws-badge ' + cls;
    b.querySelector('.label').textContent = label;
  }

  // ── Live Events ───────────────────────────────────────────────────────────
  function onLiveEvent(event) {
    liveEvents.unshift(event);
    if (liveEvents.length > 200) liveEvents.pop();

    document.getElementById('liveCount').textContent = liveEvents.length;
    document.getElementById('feedEmpty').style.display = 'none';

    const feed = document.getElementById('eventFeed');
    const card = buildEventCard(event);

    if (activeFilters.size === 0 || activeFilters.has(event.risk_level)) {
      feed.insertBefore(card, feed.children[1]); // after empty placeholder
    }
  }

  function buildEventCard(event) {
    const streamName = (streams.find(s => s.id === event.stream_id) || {}).name || event.stream_id;
    const tags = (event.events || []).map(e =>
      `<span class="event-tag">${fmt(e.event_type)}${e.confidence ? ' · ' + Math.round(e.confidence * 100) + '%' : ''}</span>`
    ).join('');
    const triggeredRuleHtml = event.triggered_rule
      ? `<div class="ec-triggered-rule">
           <span class="tr-label">Rule</span>
           <span class="tr-desc" title="${htmlEsc(event.triggered_rule)}">${htmlEsc(event.triggered_rule)}</span>
         </div>`
      : '';

    const card = document.createElement('div');
    card.className = 'event-card';
    card.dataset.risk = event.risk_level || 'none';
    card.dataset.id   = event.id;
    card.innerHTML = `
      <div class="ec-top">
        <span class="risk-badge risk-${event.risk_level || 'none'}">${event.risk_level || 'none'}</span>
        <span class="ec-stream">${streamName}</span>
        <span class="ec-time">${fmtTime(event.captured_at)}</span>
      </div>
      <div class="ec-description">${event.description || '—'}</div>
      ${tags ? `<div class="ec-tags">${tags}</div>` : ''}
      ${triggeredRuleHtml}
    `;
    return card;
  }

  function togglePill(el) {
    const risk = el.dataset.risk;
    if (activeFilters.has(risk)) {
      activeFilters.delete(risk);
      el.className = 'pill';
    } else {
      activeFilters.add(risk);
      el.className = `pill active-${risk}`;
    }
    renderFeed();
  }

  function renderFeed() {
    const feed = document.getElementById('eventFeed');
    // Keep only the empty placeholder
    while (feed.children.length > 1) feed.removeChild(feed.lastChild);

    const visible = activeFilters.size === 0
      ? liveEvents
      : liveEvents.filter(e => activeFilters.has(e.risk_level));

    if (visible.length === 0) {
      document.getElementById('feedEmpty').style.display = '';
    } else {
      document.getElementById('feedEmpty').style.display = 'none';
      visible.forEach(e => feed.appendChild(buildEventCard(e)));
    }
  }

  function clearFeed() {
    liveEvents = [];
    document.getElementById('liveCount').textContent = '0';
    document.getElementById('feedEmpty').style.display = '';
    const feed = document.getElementById('eventFeed');
    while (feed.children.length > 1) feed.removeChild(feed.lastChild);
  }

  // ── Streams ───────────────────────────────────────────────────────────────
  async function loadStreams() {
    try {
      const res = await fetch(`${API}/api/streams`);
      streams = await res.json();
      renderStreams();
      renderCameras();
      syncHistoryStreamFilter();
    } catch (e) {
      toast('Could not reach backend', 'err');
    }
  }

  function renderCameras() {
    const grid = document.getElementById('camerasGrid');
    document.getElementById('camCount').textContent = streams.length;

    if (!streams.length) {
      grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;margin-top:40px">No streams configured</div>';
      return;
    }

    grid.innerHTML = streams.map(s => `
      <div class="camera-tile">
        ${s.enabled
          ? `<img class="camera-feed" src="${API}/api/streams/${s.id}/live" alt="${s.name}" />`
          : `<div class="camera-paused">Paused</div>`
        }
        <div class="camera-label">
          ${s.enabled ? '<div class="live-dot"></div>' : ''}
          <span class="sc-type">${s.source_type}</span>
          <span style="flex:1">${s.name}</span>
          <span style="color:var(--muted);font-size:11px;font-weight:400">${s.capture_interval_sec}s</span>
        </div>
      </div>
    `).join('');
  }

  function renderStreams() {
    const list = document.getElementById('streamList');
    if (!streams.length) {
      list.innerHTML = '<div class="empty-state">No streams yet</div>';
      return;
    }
    list.innerHTML = streams.map(s => `
      <div class="stream-card" id="sc-${s.id}">
        <div class="sc-top">
          <span class="sc-name" title="${htmlEsc(s.name)}">${htmlEsc(s.name)}</span>
          <span class="sc-type">${htmlEsc(s.source_type)}</span>
        </div>
        <div class="sc-meta" title="${htmlEsc(s.source_url)}">${htmlEsc(s.source_url)}</div>
        <div class="sc-meta">Every ${s.capture_interval_sec}s</div>
        <div class="sc-actions">
          <button class="btn btn-sm btn-toggle ${s.enabled ? '' : 'off'}"
                  onclick="toggleStream('${s.id}', ${s.enabled})">
            ${s.enabled ? 'Enabled' : 'Disabled'}
          </button>
          <button class="btn btn-sm btn-rules" id="rbtn-${s.id}"
                  onclick="toggleRulesPanel('${s.id}')">Rules</button>
          <button class="btn btn-sm btn-danger" onclick="deleteStream('${s.id}')">Delete</button>
        </div>
        <div class="rules-panel" id="rules-${s.id}" style="display:none">
          <div class="rules-list" id="rules-list-${s.id}"></div>
          <div class="add-rule-form">
            <input id="rule-desc-${s.id}" type="text" placeholder="Rule description…" />
            <select id="rule-level-${s.id}" class="sel-level">
              <option value="none">None</option>
              <option value="low" selected>Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
            <button class="btn-add-rule" onclick="addRule('${s.id}')">+ Add</button>
          </div>
        </div>
      </div>
    `).join('');

    // Reopen panels that were open before the list re-rendered
    openRulePanels.forEach(id => {
      const panel = document.getElementById(`rules-${id}`);
      const btn   = document.getElementById(`rbtn-${id}`);
      if (panel) {
        panel.style.display = 'block';
        btn?.classList.add('open');
        loadRules(id);
      } else {
        openRulePanels.delete(id);
      }
    });
  }

  function syncHistoryStreamFilter() {
    const sel = document.getElementById('hStream');
    const current = sel.value;
    sel.innerHTML = '<option value="">All streams</option>' +
      streams.map(s => `<option value="${s.id}" ${s.id === current ? 'selected' : ''}>${s.name}</option>`).join('');
  }

  async function addStream() {
    const name     = document.getElementById('sName').value.trim();
    const type     = document.getElementById('sType').value;
    const url      = document.getElementById('sUrl').value.trim();
    const interval = parseInt(document.getElementById('sInterval').value) || 5;

    if (!name || !url) { toast('Name and URL are required', 'err'); return; }

    try {
      const res = await fetch(`${API}/api/streams`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, source_type: type, source_url: url, capture_interval_sec: interval }),
      });
      if (!res.ok) throw new Error(await res.text());
      document.getElementById('sName').value = '';
      document.getElementById('sUrl').value  = '';
      toast(`Stream "${name}" added`, 'ok');
      await loadStreams();
    } catch (e) {
      toast('Failed: ' + e.message, 'err');
    }
  }

  async function toggleStream(id, currentlyEnabled) {
    const action = currentlyEnabled ? 'disable' : 'enable';
    try {
      const res = await fetch(`${API}/api/streams/${id}/${action}`, { method: 'POST' });
      if (!res.ok) throw new Error(await res.text());
      toast(`Stream ${action}d`, 'ok');
      await loadStreams();
    } catch (e) {
      toast('Failed: ' + e.message, 'err');
    }
  }

  async function deleteStream(id) {
    if (!confirm('Delete this stream and all its events?')) return;
    try {
      const res = await fetch(`${API}/api/streams/${id}`, { method: 'DELETE' });
      if (!res.ok && res.status !== 204) throw new Error(await res.text());
      toast('Stream deleted', 'ok');
      await loadStreams();
    } catch (e) {
      toast('Failed: ' + e.message, 'err');
    }
  }

  // ── Stream Rules ──────────────────────────────────────────────────────────
  // Cache of rules per stream id to avoid re-fetch when switching edit modes
  const rulesCache = {};

  async function toggleRulesPanel(streamId) {
    const panel = document.getElementById(`rules-${streamId}`);
    const btn   = document.getElementById(`rbtn-${streamId}`);
    if (openRulePanels.has(streamId)) {
      openRulePanels.delete(streamId);
      panel.style.display = 'none';
      btn.classList.remove('open');
    } else {
      openRulePanels.add(streamId);
      panel.style.display = 'block';
      btn.classList.add('open');
      await loadRules(streamId);
    }
  }

  async function loadRules(streamId) {
    try {
      const res = await fetch(`${API}/api/streams/${streamId}/rules`);
      if (!res.ok) throw new Error(await res.text());
      const rules = await res.json();
      rulesCache[streamId] = rules;
      renderRules(streamId, rules);
    } catch (e) {
      toast('Failed to load rules', 'err');
    }
  }

  function renderRules(streamId, rules) {
    const list = document.getElementById(`rules-list-${streamId}`);
    if (!list) return;
    if (!rules.length) {
      list.innerHTML = '<div class="rules-empty">No rules yet — add one below</div>';
      return;
    }
    list.innerHTML = rules.map(r => `
      <div class="rule-item" id="ri-${r.id}">
        <span class="rule-badge rule-${r.threat_level}">${htmlEsc(r.threat_level)}</span>
        <span class="rule-desc" title="${htmlEsc(r.description)}">${htmlEsc(r.description)}</span>
        <div class="rule-btns">
          <button class="btn-icon" title="Edit"
                  onclick="startEditRule('${streamId}','${r.id}')">&#9998;</button>
          <button class="btn-icon del" title="Delete"
                  onclick="deleteRule('${streamId}','${r.id}')">&#x2715;</button>
        </div>
      </div>
    `).join('');
  }

  function startEditRule(streamId, ruleId) {
    const rules = rulesCache[streamId] || [];
    const r = rules.find(x => x.id === ruleId);
    if (!r) return;
    const item = document.getElementById(`ri-${ruleId}`);
    if (!item) return;

    item.innerHTML = `
      <div class="rule-edit-row">
        <input id="ed-desc-${ruleId}" type="text" value="${htmlEsc(r.description)}" />
        <select id="ed-level-${ruleId}">
          <option value="none"   ${r.threat_level==='none'  ?'selected':''}>None</option>
          <option value="low"    ${r.threat_level==='low'   ?'selected':''}>Low</option>
          <option value="medium" ${r.threat_level==='medium'?'selected':''}>Medium</option>
          <option value="high"   ${r.threat_level==='high'  ?'selected':''}>High</option>
        </select>
        <button class="btn-save"   onclick="saveRule('${streamId}','${ruleId}',${r.position})">Save</button>
        <button class="btn-cancel" onclick="renderRules('${streamId}', rulesCache['${streamId}'] || [])">Cancel</button>
      </div>
    `;
    document.getElementById(`ed-desc-${ruleId}`).focus();
  }

  async function saveRule(streamId, ruleId, position) {
    const desc  = document.getElementById(`ed-desc-${ruleId}`)?.value.trim();
    const level = document.getElementById(`ed-level-${ruleId}`)?.value;
    if (!desc) { toast('Description is required', 'err'); return; }
    try {
      const res = await fetch(`${API}/api/streams/${streamId}/rules/${ruleId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: desc, threat_level: level, position }),
      });
      if (!res.ok) throw new Error(await res.text());
      toast('Rule updated', 'ok');
      await loadRules(streamId);
    } catch (e) {
      toast('Failed: ' + e.message, 'err');
    }
  }

  async function deleteRule(streamId, ruleId) {
    try {
      const res = await fetch(`${API}/api/streams/${streamId}/rules/${ruleId}`, { method: 'DELETE' });
      if (!res.ok && res.status !== 204) throw new Error(await res.text());
      toast('Rule deleted', 'ok');
      await loadRules(streamId);
    } catch (e) {
      toast('Failed: ' + e.message, 'err');
    }
  }

  async function addRule(streamId) {
    const descEl  = document.getElementById(`rule-desc-${streamId}`);
    const levelEl = document.getElementById(`rule-level-${streamId}`);
    const desc    = descEl.value.trim();
    const level   = levelEl.value;
    if (!desc) { toast('Rule description is required', 'err'); descEl.focus(); return; }

    const existing = rulesCache[streamId] || [];
    const position = existing.length; // append at end

    try {
      const res = await fetch(`${API}/api/streams/${streamId}/rules`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: desc, threat_level: level, position }),
      });
      if (!res.ok) throw new Error(await res.text());
      descEl.value = '';
      levelEl.value = 'low';
      toast('Rule added', 'ok');
      await loadRules(streamId);
    } catch (e) {
      toast('Failed: ' + e.message, 'err');
    }
  }

  // ── History ───────────────────────────────────────────────────────────────
  async function loadHistory() {
    const streamId = document.getElementById('hStream').value;
    const risk     = document.getElementById('hRisk').value;
    const from     = document.getElementById('hFrom').value;
    const to       = document.getElementById('hTo').value;

    const params = new URLSearchParams({ limit: 100 });
    if (streamId) params.set('stream_id', streamId);
    if (risk)     params.set('risk_level', risk);
    if (from)     params.set('from', new Date(from).toISOString());
    if (to)       params.set('to',   new Date(to).toISOString());

    try {
      const res = await fetch(`${API}/api/events?${params}`);
      const events = await res.json();
      renderHistory(events);
    } catch (e) {
      toast('Failed to load history', 'err');
    }
  }

  function renderHistory(events) {
    const list = document.getElementById('historyList');
    if (!events.length) {
      list.innerHTML = '<div class="empty-state">No events found</div>';
      return;
    }
    list.innerHTML = '';
    events.forEach(e => list.appendChild(buildEventCard(e)));
  }

  // ── Tabs ─────────────────────────────────────────────────────────────────
  function switchTab(name, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('tab-' + name).classList.add('active');
    if (name === 'history') loadHistory();
  }

  // ── Helpers ───────────────────────────────────────────────────────────────
  function htmlEsc(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function fmt(s) {
    return (s || '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  function fmtTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  let toastTimer;
  function toast(msg, type) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'show ' + (type || '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.className = '', 3000);
  }

  // ── Init ──────────────────────────────────────────────────────────────────
  loadStreams();
  connectWs();
</script>
</body>
</html>
