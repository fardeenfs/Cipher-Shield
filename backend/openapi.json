{
    "openapi": "3.0.3",
    "info": {
        "title": "Cipher-Shield API",
        "description": "REST API for the Cipher-Shield video stream analysis platform. Manage streams, blueprints, and analysis events.",
        "contact": {
            "name": "Cipher-Shield",
            "email": "admin@cipher-shield.local"
        },
        "license": {
            "name": "MIT"
        },
        "version": "0.1.0"
    },
    "paths": {
        "/api/blueprints": {
            "get": {
                "tags": [
                    "blueprints"
                ],
                "operationId": "list_blueprints",
                "responses": {
                    "200": {
                        "description": "List of blueprints (no image data)",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "array",
                                    "items": {
                                        "$ref": "#/components/schemas/BlueprintSummary"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "post": {
                "tags": [
                    "blueprints"
                ],
                "operationId": "create_blueprint",
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/CreateBlueprintRequest"
                            }
                        }
                    },
                    "required": true
                },
                "responses": {
                    "201": {
                        "description": "Blueprint created",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/BlueprintResponse"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Invalid request (e.g. invalid base64)"
                    }
                }
            }
        },
        "/api/blueprints/{id}": {
            "get": {
                "tags": [
                    "blueprints"
                ],
                "operationId": "get_blueprint",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Blueprint ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Blueprint with image as base64",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/BlueprintResponse"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Blueprint not found"
                    }
                }
            },
            "put": {
                "tags": [
                    "blueprints"
                ],
                "operationId": "update_blueprint",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Blueprint ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/UpdateBlueprintRequest"
                            }
                        }
                    },
                    "required": true
                },
                "responses": {
                    "200": {
                        "description": "Blueprint updated",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/BlueprintResponse"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Invalid request"
                    },
                    "404": {
                        "description": "Blueprint not found"
                    }
                }
            },
            "delete": {
                "tags": [
                    "blueprints"
                ],
                "operationId": "delete_blueprint",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Blueprint ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "204": {
                        "description": "Blueprint deleted"
                    },
                    "404": {
                        "description": "Blueprint not found"
                    }
                }
            }
        },
        "/api/events": {
            "get": {
                "tags": [
                    "events"
                ],
                "operationId": "list_events",
                "parameters": [
                    {
                        "name": "stream_id",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "format": "uuid",
                            "nullable": true
                        }
                    },
                    {
                        "name": "risk_level",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "nullable": true
                        }
                    },
                    {
                        "name": "from",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "format": "date-time",
                            "nullable": true
                        }
                    },
                    {
                        "name": "to",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "format": "date-time",
                            "nullable": true
                        }
                    },
                    {
                        "name": "limit",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "integer",
                            "format": "int64"
                        }
                    },
                    {
                        "name": "offset",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "integer",
                            "format": "int64"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "List of analysis events",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "array",
                                    "items": {
                                        "$ref": "#/components/schemas/AnalysisEvent"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/events/{id}": {
            "get": {
                "tags": [
                    "events"
                ],
                "operationId": "get_event",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Event ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Analysis event found",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/AnalysisEvent"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Event not found"
                    }
                }
            }
        },
        "/api/health": {
            "get": {
                "tags": [
                    "health"
                ],
                "operationId": "health",
                "responses": {
                    "200": {
                        "description": "Service is healthy",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "status": "ok"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/api/streams": {
            "get": {
                "tags": [
                    "streams"
                ],
                "operationId": "list_streams",
                "parameters": [
                    {
                        "name": "blueprint_id",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "format": "uuid",
                            "nullable": true
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "List of streams (optionally filter by blueprint_id)",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "array",
                                    "items": {
                                        "$ref": "#/components/schemas/Stream"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "post": {
                "tags": [
                    "streams"
                ],
                "operationId": "create_stream",
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/CreateStreamRequest"
                            }
                        }
                    },
                    "required": true
                },
                "responses": {
                    "201": {
                        "description": "Stream created",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Stream"
                                }
                            }
                        }
                    },
                    "400": {
                        "description": "Invalid request body"
                    }
                }
            }
        },
        "/api/streams/{id}": {
            "get": {
                "tags": [
                    "streams"
                ],
                "operationId": "get_stream",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Stream found",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Stream"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Stream not found"
                    }
                }
            },
            "put": {
                "tags": [
                    "streams"
                ],
                "operationId": "update_stream",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/UpdateStreamRequest"
                            }
                        }
                    },
                    "required": true
                },
                "responses": {
                    "200": {
                        "description": "Stream updated",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Stream"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Stream not found"
                    }
                }
            },
            "delete": {
                "tags": [
                    "streams"
                ],
                "operationId": "delete_stream",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "204": {
                        "description": "Stream deleted"
                    },
                    "404": {
                        "description": "Stream not found"
                    }
                }
            }
        },
        "/api/streams/{id}/disable": {
            "post": {
                "tags": [
                    "streams"
                ],
                "operationId": "disable_stream",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Stream disabled",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Stream"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Stream not found"
                    }
                }
            }
        },
        "/api/streams/{id}/enable": {
            "post": {
                "tags": [
                    "streams"
                ],
                "operationId": "enable_stream",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Stream enabled",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Stream"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Stream not found"
                    }
                }
            }
        },
        "/api/streams/{id}/live": {
            "get": {
                "tags": [
                    "streams"
                ],
                "summary": "Streams live MJPEG frames for a stream.",
                "description": "Use as `<img src=\"/api/streams/:id/live\">` — browsers handle MJPEG natively.",
                "operationId": "stream_live",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Live MJPEG stream (multipart/x-mixed-replace)"
                    }
                }
            }
        },
        "/api/streams/{id}/rules": {
            "get": {
                "tags": [
                    "rules"
                ],
                "operationId": "list_rules",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Rules for the stream",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "array",
                                    "items": {
                                        "$ref": "#/components/schemas/StreamRule"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "post": {
                "tags": [
                    "rules"
                ],
                "operationId": "create_rule",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/CreateRuleRequest"
                            }
                        }
                    },
                    "required": true
                },
                "responses": {
                    "201": {
                        "description": "Rule created",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/StreamRule"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Stream not found"
                    }
                }
            }
        },
        "/api/streams/{id}/rules/{rule_id}": {
            "put": {
                "tags": [
                    "rules"
                ],
                "operationId": "update_rule",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    },
                    {
                        "name": "rule_id",
                        "in": "path",
                        "description": "Rule ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/UpdateRuleRequest"
                            }
                        }
                    },
                    "required": true
                },
                "responses": {
                    "200": {
                        "description": "Rule updated",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/StreamRule"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Rule not found"
                    }
                }
            },
            "delete": {
                "tags": [
                    "rules"
                ],
                "operationId": "delete_rule",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    },
                    {
                        "name": "rule_id",
                        "in": "path",
                        "description": "Rule ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "204": {
                        "description": "Rule deleted"
                    },
                    "404": {
                        "description": "Rule not found"
                    }
                }
            }
        },
        "/api/streams/{id}/snapshot": {
            "get": {
                "tags": [
                    "streams"
                ],
                "summary": "Returns the most recently captured JPEG frame for a stream.",
                "operationId": "snapshot",
                "parameters": [
                    {
                        "name": "id",
                        "in": "path",
                        "description": "Stream ID",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Latest JPEG frame"
                    },
                    "404": {
                        "description": "No frame captured yet"
                    }
                }
            }
        },
        "/api/test-twilio": {
            "post": {
                "tags": [
                    "notifications"
                ],
                "summary": "Sends one test SMS via Twilio. Use to verify Twilio env vars and ALERT_PHONE_NUMBER.",
                "operationId": "test_twilio_alert",
                "responses": {
                    "200": {
                        "description": "Test SMS triggered",
                        "content": {
                            "application/json": {
                                "schema": {},
                                "example": {
                                    "message": "Test alert triggered. Check ALERT_PHONE_NUMBER for SMS (and backend logs if none)."
                                }
                            }
                        }
                    }
                }
            }
        }
    },
    "components": {
        "schemas": {
            "AnalysisEvent": {
                "type": "object",
                "description": "Mirrors the `analysis_events` table.",
                "required": [
                    "id",
                    "stream_id",
                    "captured_at",
                    "description",
                    "events",
                    "risk_level",
                    "created_at"
                ],
                "properties": {
                    "captured_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "description": {
                        "type": "string"
                    },
                    "events": {},
                    "id": {
                        "type": "string",
                        "format": "uuid"
                    },
                    "raw_response": {
                        "type": "string",
                        "nullable": true
                    },
                    "risk_level": {
                        "type": "string"
                    },
                    "stream_id": {
                        "type": "string",
                        "format": "uuid"
                    }
                }
            },
            "BlueprintResponse": {
                "type": "object",
                "description": "Blueprint as returned by API (image as base64 string).",
                "required": [
                    "id",
                    "name",
                    "created_at",
                    "updated_at"
                ],
                "properties": {
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "id": {
                        "type": "string",
                        "format": "uuid"
                    },
                    "image_base64": {
                        "type": "string",
                        "nullable": true
                    },
                    "name": {
                        "type": "string"
                    },
                    "updated_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                }
            },
            "BlueprintSummary": {
                "type": "object",
                "description": "Blueprint without image (for list).",
                "required": [
                    "id",
                    "name",
                    "created_at",
                    "updated_at"
                ],
                "properties": {
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "id": {
                        "type": "string",
                        "format": "uuid"
                    },
                    "name": {
                        "type": "string"
                    },
                    "updated_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                }
            },
            "CreateBlueprintRequest": {
                "type": "object",
                "properties": {
                    "image_base64": {
                        "type": "string",
                        "description": "Base64-encoded image (optional).",
                        "nullable": true
                    },
                    "name": {
                        "type": "string",
                        "nullable": true
                    }
                }
            },
            "CreateRuleRequest": {
                "type": "object",
                "required": [
                    "description",
                    "threat_level"
                ],
                "properties": {
                    "description": {
                        "type": "string"
                    },
                    "position": {
                        "type": "integer",
                        "format": "int32"
                    },
                    "threat_level": {
                        "type": "string",
                        "description": "\"none\" | \"low\" | \"medium\" | \"high\""
                    }
                }
            },
            "CreateStreamRequest": {
                "type": "object",
                "description": "Payload for creating a new stream via the REST API.",
                "required": [
                    "name",
                    "source_type",
                    "source_url"
                ],
                "properties": {
                    "blueprint_id": {
                        "type": "string",
                        "format": "uuid",
                        "description": "Optional blueprint to bind this stream to.",
                        "nullable": true
                    },
                    "capture_interval_sec": {
                        "type": "integer",
                        "format": "int32"
                    },
                    "enabled": {
                        "type": "boolean"
                    },
                    "name": {
                        "type": "string"
                    },
                    "source_type": {
                        "type": "string"
                    },
                    "source_url": {
                        "type": "string"
                    }
                }
            },
            "Stream": {
                "type": "object",
                "description": "Mirrors the `streams` table. Stream = camera; belongs to at most one blueprint (blueprint_id).",
                "required": [
                    "id",
                    "name",
                    "source_type",
                    "source_url",
                    "capture_interval_sec",
                    "enabled",
                    "position_x",
                    "position_y",
                    "rotation",
                    "created_at",
                    "updated_at"
                ],
                "properties": {
                    "blueprint_id": {
                        "type": "string",
                        "format": "uuid",
                        "description": "Blueprint this stream is placed on (one stream → one blueprint).",
                        "nullable": true
                    },
                    "capture_interval_sec": {
                        "type": "integer",
                        "format": "int32"
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "enabled": {
                        "type": "boolean"
                    },
                    "id": {
                        "type": "string",
                        "format": "uuid"
                    },
                    "name": {
                        "type": "string"
                    },
                    "phone_number": {
                        "type": "string",
                        "nullable": true
                    },
                    "position_x": {
                        "type": "number",
                        "format": "double"
                    },
                    "position_y": {
                        "type": "number",
                        "format": "double"
                    },
                    "rotation": {
                        "type": "number",
                        "format": "double"
                    },
                    "source_type": {
                        "type": "string"
                    },
                    "source_url": {
                        "type": "string"
                    },
                    "updated_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                }
            },
            "StreamRule": {
                "type": "object",
                "description": "A per-stream rule the VLM uses to assign threat levels.",
                "required": [
                    "id",
                    "stream_id",
                    "description",
                    "threat_level",
                    "position",
                    "created_at",
                    "updated_at"
                ],
                "properties": {
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "description": {
                        "type": "string",
                        "description": "Human-readable description, e.g. \"Person climbing the fence\"."
                    },
                    "id": {
                        "type": "string",
                        "format": "uuid"
                    },
                    "position": {
                        "type": "integer",
                        "format": "int32",
                        "description": "Display / prompt ordering (lower = earlier)."
                    },
                    "stream_id": {
                        "type": "string",
                        "format": "uuid"
                    },
                    "threat_level": {
                        "type": "string",
                        "description": "\"none\" | \"low\" | \"medium\" | \"high\""
                    },
                    "updated_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                }
            },
            "UpdateBlueprintRequest": {
                "type": "object",
                "properties": {
                    "image_base64": {
                        "type": "string",
                        "nullable": true
                    },
                    "name": {
                        "type": "string",
                        "nullable": true
                    }
                }
            },
            "UpdateRuleRequest": {
                "type": "object",
                "properties": {
                    "description": {
                        "type": "string",
                        "nullable": true
                    },
                    "position": {
                        "type": "integer",
                        "format": "int32",
                        "nullable": true
                    },
                    "threat_level": {
                        "type": "string",
                        "nullable": true
                    }
                }
            },
            "UpdateStreamRequest": {
                "type": "object",
                "description": "Payload for updating an existing stream.",
                "properties": {
                    "blueprint_id": {
                        "type": "string",
                        "format": "uuid",
                        "description": "Set to null in JSON to unbind from blueprint; omit to leave unchanged.",
                        "nullable": true
                    },
                    "capture_interval_sec": {
                        "type": "integer",
                        "format": "int32",
                        "nullable": true
                    },
                    "enabled": {
                        "type": "boolean",
                        "nullable": true
                    },
                    "name": {
                        "type": "string",
                        "nullable": true
                    },
                    "phone_number": {
                        "type": "string",
                        "nullable": true
                    },
                    "position_x": {
                        "type": "number",
                        "format": "double",
                        "nullable": true
                    },
                    "position_y": {
                        "type": "number",
                        "format": "double",
                        "nullable": true
                    },
                    "rotation": {
                        "type": "number",
                        "format": "double",
                        "nullable": true
                    },
                    "source_type": {
                        "type": "string",
                        "nullable": true
                    },
                    "source_url": {
                        "type": "string",
                        "nullable": true
                    }
                }
            }
        }
    },
    "tags": [
        {
            "name": "health",
            "description": "Service health check"
        },
        {
            "name": "streams",
            "description": "Video stream management"
        },
        {
            "name": "events",
            "description": "Analysis event retrieval"
        },
        {
            "name": "rules",
            "description": "Per-stream VLM threat assessment rules"
        },
        {
            "name": "blueprints",
            "description": "Blueprints (floor plan images)"
        },
        {
            "name": "notifications",
            "description": "Alert / notification testing"
        }
    ]
}